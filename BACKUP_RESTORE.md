# Резервное копирование и восстановление рабочих данных

Система резервного копирования позволяет создавать полные резервные копии всех рабочих данных и восстанавливать их при необходимости.

## Что включается в резервную копию

### Обязательные директории:
- `documents/` - исходные документы (основные рабочие данные)
- `version_history/` - история изменений документов
- `config/` - конфигурационные файлы

### Опциональные директории:
- `html/` - сгенерированные HTML файлы (можно исключить)
- `pdf/` - сгенерированные PDF файлы (можно исключить)

### Файлы:
- `requirements.txt` - зависимости проекта
- `README.md` - документация проекта

## Создание резервной копии

### Через скрипт-обертку (рекомендуется)

```bash
# Linux/macOS
./backup.sh

# Windows
backup.bat
```

### Через Python напрямую

```bash
python scripts/backup_restore.py backup
```

### Параметры создания резервной копии

```bash
# С комментарием
./backup.sh --comment "Резервная копия перед обновлением"

# Без HTML файлов
./backup.sh --no-html

# Без PDF файлов
./backup.sh --no-pdf

# Без HTML и PDF
./backup.sh --no-html --no-pdf

# Указать другую директорию для резервных копий
./backup.sh --backup-dir /path/to/backups
```

## Просмотр списка резервных копий

```bash
python scripts/backup_restore.py list
```

Вывод:
```
Найдено резервных копий: 2

№    Дата создания        Размер       Комментарий                   
--------------------------------------------------------------------------------
1    2024-11-30 08:33:11      0.25 MB   Тестовая резервная копия      
2    2024-11-29 15:20:45      0.23 MB   Резервная копия перед обновлением
```

## Восстановление из резервной копии

### ⚠️ ВНИМАНИЕ: Восстановление заменяет все существующие рабочие данные!

### Через скрипт-обертку

```bash
# Linux/macOS
./restore.sh 1 --replace

# Windows
restore.bat 1 --replace
```

### Через Python напрямую

```bash
# Восстановление по номеру из списка
python scripts/backup_restore.py restore 1 --replace

# Восстановление по имени файла
python scripts/backup_restore.py restore backup_20241130_083311.tar.gz --replace

# Восстановление по полному пути
python scripts/backup_restore.py restore /path/to/backup.tar.gz --replace
```

### Параметры восстановления

```bash
# Восстановление с заменой существующих данных (обязательно!)
./restore.sh 1 --replace

# Восстановление без HTML файлов
./restore.sh 1 --replace --no-html

# Восстановление без PDF файлов
./restore.sh 1 --replace --no-pdf

# Восстановление без создания резервной копии перед восстановлением
./restore.sh 1 --replace --no-backup-before
```

## Безопасность

### Автоматические проверки:

1. **Проверка целостности архива** - перед восстановлением проверяется, что архив не поврежден
2. **Проверка наличия критических данных** - проверяется наличие директории `documents/`
3. **Автоматическая резервная копия** - перед восстановлением автоматически создается резервная копия текущих данных (если они есть)
4. **Предупреждения** - система предупреждает о замене существующих данных

### Рекомендации:

1. **Регулярное резервное копирование** - создавайте резервные копии перед важными изменениями
2. **Хранение резервных копий** - храните резервные копии в безопасном месте (не только на рабочем сервере)
3. **Проверка резервных копий** - периодически проверяйте целостность резервных копий
4. **Версионирование** - используйте комментарии для описания резервных копий

## Структура резервной копии

Резервная копия представляет собой сжатый tar.gz архив, содержащий:

```
backup_YYYYMMDD_HHMMSS.tar.gz
├── documents/              # Исходные документы
├── version_history/        # История изменений
├── html/                   # HTML файлы (опционально)
├── pdf/                    # PDF файлы (опционально)
├── config/                 # Конфигурация
├── requirements.txt        # Зависимости
├── README.md               # Документация
└── backup_metadata.json    # Метаданные резервной копии
```

### Метаданные резервной копии

Файл `backup_metadata.json` содержит:
- Дата и время создания
- Комментарий (если указан)
- Список включенных директорий
- Список включенных файлов
- Базовая директория проекта

## Примеры использования

### Ежедневное резервное копирование

```bash
# Создать резервную копию с текущей датой
./backup.sh --comment "Ежедневная резервная копия $(date +%Y-%m-%d)"
```

### Резервная копия перед обновлением

```bash
# Создать резервную копию
./backup.sh --comment "Перед обновлением системы"

# Выполнить обновление...

# Если что-то пошло не так, восстановить
./restore.sh 1 --replace
```

### Восстановление на новом сервере

```bash
# Скопировать резервную копию на новый сервер
scp backups/backup_20241130_083311.tar.gz new-server:/path/to/project/

# На новом сервере восстановить
cd /path/to/project
python scripts/backup_restore.py restore backup_20241130_083311.tar.gz --replace
```

## Устранение неполадок

### Ошибка "Резервная копия не найдена"

Проверьте:
- Правильность пути к файлу
- Наличие файла в указанной директории
- Используйте `list` для просмотра доступных резервных копий

### Ошибка "Архив не содержит директорию 'documents'"

Архив поврежден или не является резервной копией этого проекта. Попробуйте другую резервную копию.

### Ошибка при восстановлении

1. Проверьте права доступа к директориям
2. Убедитесь, что достаточно места на диске
3. Проверьте целостность архива: `tar -tzf backup.tar.gz`

## API использование

```python
from scripts.backup_restore import BackupRestore

# Создание резервной копии
backup = BackupRestore()
backup_path = backup.create_backup(
    include_html=True,
    include_pdf=True,
    comment="Программное создание резервной копии"
)

# Восстановление
success = backup.restore_backup(
    backup_path,
    replace_existing=True,
    restore_html=True,
    restore_pdf=True
)

# Список резервных копий
backups = backup.list_backups()
for b in backups:
    print(f"{b['filename']}: {b['size'] / 1024 / 1024:.2f} MB")
```

